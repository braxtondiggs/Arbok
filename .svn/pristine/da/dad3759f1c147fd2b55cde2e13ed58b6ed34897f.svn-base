var myPlaylist;
$(function() {
	var host = document.location.origin;
	var socket = io.connect(host); 
	socket.on('connect', function(data){
		socket.emit('screen');
		socket.on("init", function(data){
			$.each(data, function(k, v) {
				addSong(v);
			});
		});
		socket.on("new song", function(data){
			addSong(data);
		});
		
		function addSong(data) {
			myPlaylist.add({
				title: data.title,
				artist:data.artist,
				free: true,
				mp3: data.mp3,
				poster: "http://www.jplayer.org/audio/poster/Miaow_640x360.png"
			});
			if ($('#jquery_jplayer_N').data().jPlayer.status.paused) {
				$('#jquery_jplayer_N').jPlayer("play");
			}
		}
	});
	myPlaylist = new jPlayerPlaylist({
		jPlayer: "#jquery_jplayer_N",
		cssSelectorAncestor: "#jp_container_N"
		}, null, {
		playlistOptions: {
			autoPlay: true,
			enableRemoveControls: true
		},
		supplied: "mp3",
		solution:"flash,html",
		smoothPlayBar: true,
		keyEnabled: true,
		audioFullScreen: true,
		ended: function() {
			ended();
		},
		loadstart: function() {
			socket.emit('song change', myPlaylist.playlist[myPlaylist.current]);
			socket.emit('playlist', myPlaylist.playlist);
		},
		pause: function() {
		    $(this).jPlayer("play");
		},
		suspend: function() {
			$(this).jPlayer("play");
		},
		error: function(event) {
			console.log('error');
		    //if(ready && event.jPlayer.error.type === $.jPlayer.error.URL_NOT_SET) {
			// Setup the media stream again and play it.
		       //$(this).jPlayer("setMedia", stream).jPlayer("play");
		    //}
		},
	});
	
	function ended() {
		var current = (parseInt(myPlaylist.current) > 0 )?parseInt(myPlaylist.current) - 1:parseInt(myPlaylist.current);	
		$.ajax({
			url: 'http://localhost:8888/Quilava/server/index.php/delete/',//'http://192.168.1.19/index.php/delete',
			type: 'POST',
			data: {file: myPlaylist.playlist[current].mp3},
			crossDomain: true,
			dataType: 'json',
			success: function(data, textStatus, jqXHR){
				
			}
		});
		myPlaylist.remove(current);
		if (current <= 0) {
			socket.emit('emptied');
		}
	}
});