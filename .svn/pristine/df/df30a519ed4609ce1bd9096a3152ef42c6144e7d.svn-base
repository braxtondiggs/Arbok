$(function() {
    $("#chat-menu").mmenu();
    $('#albums').isotope({
            itemSelector: 'li',
            masonry: {
                isFitWidth: true,
                columnWidth: 150
            }
        })

    $('header').on('click', function() {
        $("#chat-menu").trigger("open.mm");console.log('some');
    });
    
    $('#pick-song').on('click', function() {
       //showAlbum();
       $('#audio').trigger('click');
       return false;
    });
    $('#audio').on('change', function() {
        var data = new FormData();
        files = event.target.files;
	$.each(files, function(key, value){
                data.append("audio", value);
	});
        $.ajax({
            url: 'http://192.168.15.228/index.php/upload',//'http://localhost:8888/Quilava/server/index.php/upload/',//'http://192.168.1.19/index.php/upload',
            type: 'POST',
            data: data,
            cache: false,
            crossDomain: true,
            dataType: 'json',
            processData: false, // Don't process the files
            contentType: false, // Set content type to false as jQuery will tell the server its a query string request
            success: function(data, textStatus, jqXHR){
                var info = data.upload_data;
                var id3 = data.id3;
                socket.emit('new song', {mp3: 'http://192.168.15.228/tmp/'+info.file_name, album: id3.TALB, title: id3.TIT2, artist: id3.TPE1, art:""});//'http://192.168.1.7:8888/Quilava/server/tmp/
                console.log(data);
            },
            error: function(jqXHR, textStatus, errorThrown){
                    // Handle errors here
                    console.log('ERRORS: ' + textStatus);
                    // STOP LOADING SPINNER
            }
        });
    });
    $('#thumbs a').on('click', function() {
        if (isEmpty) {
            var thumb = $('#thumb-'+ $(this).data('id')+' > span');
            thumb.text(parseInt(thumb.data("count")) + 1).data("count", parseInt(thumb.data("count")) + 1);
            socket.emit('vote', {'action': $(this).data('id')});
        }else {
            alert('no songs to vote on');
        }
        return false;
    });
    if(window.location.hash) {
      var hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character
      if (hash == "album") {
        showAlbum();
      }
    }
});

document.addEventListener("deviceready", onDeviceReady, false);
document.addEventListener("offline", onOffline, false);

        // device APIs are available
        //
        function onDeviceReady() {
            checkConnection();

        }
        
function onFileSystemSuccess(fileSystem) {
    //fileSystem.root.getDirectory(".myapp", {create: false, exclusive: false}, getDirSuccess, fail);
    var directoryReader = fileSystem.root.createReader();
    
     directoryReader.readEntries(readerSuccess,fail);
}

function getDirSuccess(dirEntry) {
    // Get a directory reader
    var directoryReader = dirEntry.createReader();

    // Get a list of all the entries in the directory
    directoryReader.readEntries(function (entries) {
                   var appFile;
                   var extension;
                   var recursive = true;
                   for (var i = 0; i < entries.length; i++) {
                    
                    extension = entries[i].name.substr(entries[i].name.lastIndexOf('.'));
                    if (entries[i].isDirectory === true && recursive === true) {
                       //Application.collectMedia(entries[i].fullPath, recursive, level + 1);
                    }
                    else if (entries[i].isFile === true && $.inArray(extension, pS) >= 0)
                    {
                       //appFile = new AppFile(entries[i].name, entries[i].fullPath);
                       //appFile.addFile();
                       console.log('File saved: ' + entries[i].fullPath);
                    }
            }
            
        }, function(evt){ // error get file system
            console.log("File System Error: "+evt.target.error.code);
        });
}

function readerSuccess(entries) {
    var i;
    for (i=0; i<entries.length; i++) {
        // Assuming everything in the Music directory is an mp3, go nuts
        // otherwise check entries[i].name to see if it ends with .mp3
        console.log(entries[i].name);
    }
}

function fail(error) {
    alert("Failed to list directory contents: " + error.code);
}
function showAlbum() {
    $('#homepage').hide();
    $('#album-list').show();
    $('header').text("QBox");
    /*
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0,
        function(fileSystem){ // success get file system

            var root = fileSystem.root;
            var path = root.fullPath;
            var directoryEntry = new DirectoryEntry('', path);
            var directoryReader = directoryEntry.createReader();
            var p =  ['.mp3', '.wav', '.m4a'];
            
            directoryReader.readEntries(
                function (entries) {
                   var appFile;
                   var extension;
                   var recursive = true;
                   for (var i = 0; i < entries.length; i++) {
                    
                    extension = entries[i].name.substr(entries[i].name.lastIndexOf('.'));
                    if (entries[i].isDirectory === true && recursive === true) {
                       //Application.collectMedia(entries[i].fullPath, recursive, level + 1);
                    }
                    else if (entries[i].isFile === true && $.inArray(extension, pS) >= 0)
                    {
                       appFile = new AppFile(entries[i].name, entries[i].fullPath);
                       appFile.addFile();
                       console.log('File saved: ' + entries[i].fullPath);
                    }
            }
            
        }, function(evt){ // error get file system
            console.log("File System Error: "+evt.target.error.code);
        });
        });*/
    
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemSuccess, fail);
    
}

function CollectMedia() {
    
    
}


function checkConnection() {
    var networkState = navigator.network.connection.type;

    var states = {};
    states[Connection.UNKNOWN]  = 'Unknown connection';
    states[Connection.ETHERNET] = 'Ethernet connection';
    states[Connection.WIFI]     = 'WiFi connection';
    states[Connection.CELL_2G]  = 'Cell 2G connection';
    states[Connection.CELL_3G]  = 'Cell 3G connection';
    states[Connection.CELL_4G]  = 'Cell 4G connection';
    states[Connection.NONE]     = 'No network connection';

    //alert('Connection type: ' + states[networkState]);
}
 
 
function onOffline() {
   // Handle the offline event
}